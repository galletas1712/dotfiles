# tmux profile for coding-focused TUIs over SSH (Claude Code, OpenAI Codex, etc.)
# Tuned for mobile terminals such as Blink on iOS while remaining desktop-safe.

##### Terminal compatibility and rendering #####
set-option -g default-shell "$SHELL"

# Use a modern TERM inside tmux (verified present on this host).
set -g default-terminal "tmux-256color"

# Tell tmux that common client terminals support truecolor and modern capabilities.
# Use explicit values (not append) so repeated reloads stay stable.
set -g terminal-features "tmux-256color:RGB,tmux-256color:clipboard,tmux-256color:extkeys,tmux-256color:focus,xterm-256color:RGB,xterm-256color:clipboard,xterm-256color:extkeys,xterm-256color:focus,screen-256color:RGB,screen-256color:clipboard"

# Backward-compatible truecolor hint for older terminfo behavior.
set -g terminal-overrides "xterm-256color:Tc,screen-256color:Tc,*:U8=0"

# Fallback for terminals/fonts that render line-drawing characters incorrectly.
# (included above in terminal-overrides)

##### Responsiveness and history #####
set -s escape-time 10
set -g repeat-time 300
set -g history-limit 200000
set -s set-clipboard external
set -g focus-events on

##### Prefix and numbering #####
# Mobile-friendly default prefix while keeping Ctrl-b compatibility.
set -g prefix C-a
set -g prefix2 C-b
unbind C-b
bind C-a send-prefix
bind C-b send-prefix -2

set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# Vim-style keys where tmux offers modes/prompts.
setw -g mode-keys vi
set -g status-keys vi

##### Pane and window workflow #####
unbind '"'
unbind %
bind s split-window -v -c "#{pane_current_path}"
bind v split-window -h -c "#{pane_current_path}"

bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Optional no-prefix navigation, useful from Blink Smart Keys.
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

bind -r H resize-pane -L 5
bind -r J resize-pane -D 3
bind -r K resize-pane -U 3
bind -r L resize-pane -R 5

bind z resize-pane -Z
bind Tab last-window
bind -r n next-window
bind -r p previous-window

# Fast config reload.
bind r source-file ~/.tmux.conf \; display-message "reloaded ~/.tmux.conf"

# Toggle auto-enter on the current pane (press prefix + e).
bind e run-shell -b '
pane_id="#{pane_id}"
active_token="$(tmux show-options -p -t "$pane_id" -v @auto_enter_token 2>/dev/null || true)"

if [ -n "$active_token" ]; then
  tmux set-option -p -t "$pane_id" -u @auto_enter_token
  tmux display-message "auto-enter OFF for $pane_id"
  exit 0
fi

token="$(date +%s%N)"
tmux set-option -p -t "$pane_id" @auto_enter_token "$token"
tmux display-message "auto-enter ON for $pane_id"

while [ "$(tmux show-options -p -t "$pane_id" -v @auto_enter_token 2>/dev/null)" = "$token" ]; do
  tmux send-keys -t "$pane_id" Enter
  sleep 0.2
done
'

##### Scrolling and copy mode (mobile-friendly) #####
set -g mouse on

# Optional fallback for pure native terminal scrollback in some mobile terminals:
# uncomment if you prefer terminal-managed scroll over tmux mouse behavior.
# set -g terminal-overrides "xterm-256color:Tc,screen-256color:Tc,*:U8=0,tmux-256color:smcup@:rmcup@,xterm-256color:smcup@:rmcup@,screen-256color:smcup@:rmcup@"

# Toggle mouse quickly if terminal-native text selection is preferred.
bind m if -F "#{mouse}" "set -g mouse off; display-message 'native scroll mode'" "set -g mouse on; display-message 'tmux mouse mode'"

# Easy entry into scrollback/copy-mode from keyboards and mobile mappings.
bind PageUp copy-mode -u
bind -n PageUp copy-mode -u
bind -n M-Up copy-mode -u

# Ultra-fine wheel rate (1 line/event) in and into copy-mode.
unbind -q -T root WheelUpPane
unbind -q -T root WheelDownPane
bind -T root WheelUpPane if-shell -F "#{||:#{pane_in_mode},#{mouse_any_flag}}" "send-keys -M" "copy-mode -e; send-keys -X -N 1 scroll-up"
bind -T root WheelDownPane if-shell -F "#{||:#{pane_in_mode},#{mouse_any_flag}}" "send-keys -M" "copy-mode -e; send-keys -X -N 1 scroll-down"

bind -T copy-mode WheelUpPane select-pane \; send-keys -X -N 1 scroll-up
bind -T copy-mode WheelDownPane select-pane \; send-keys -X -N 1 scroll-down
bind -T copy-mode-vi WheelUpPane select-pane \; send-keys -X -N 1 scroll-up
bind -T copy-mode-vi WheelDownPane select-pane \; send-keys -X -N 1 scroll-down

bind -T copy-mode-vi v send-keys -X begin-selection
# Keep copy-mode active after copying so selection can be retried/verified.
bind -T copy-mode-vi y send-keys -X copy-selection
bind -T copy-mode-vi Enter send-keys -X copy-selection
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-selection-no-clear
bind -T copy-mode-vi DoubleClick1Pane select-pane \; send-keys -X select-word \; run-shell -d 0.3 \; send-keys -X copy-selection-no-clear
bind -T copy-mode-vi TripleClick1Pane select-pane \; send-keys -X select-line \; run-shell -d 0.3 \; send-keys -X copy-selection-no-clear

bind -T copy-mode Enter send-keys -X copy-selection
bind -T copy-mode C-w send-keys -X copy-selection
bind -T copy-mode M-w send-keys -X copy-selection
bind -T copy-mode MouseDragEnd1Pane send-keys -X copy-selection-no-clear
bind -T copy-mode DoubleClick1Pane select-pane \; send-keys -X select-word \; run-shell -d 0.3 \; send-keys -X copy-selection-no-clear
bind -T copy-mode TripleClick1Pane select-pane \; send-keys -X select-line \; run-shell -d 0.3 \; send-keys -X copy-selection-no-clear

bind -T copy-mode-vi r send-keys -X rectangle-toggle

##### Compact status line for small screens #####
set -g status-position top
set -g status-interval 1
set -g status-left-length 30
set -g status-right-length 80
set -g status-left "#[bold]#S#[default] "
set -g status-right "#(whoami)@#H"
set -g pane-border-status top
set -g pane-border-format "#{pane_index}#{?@auto_enter_token, #[fg=colour196]#[bold]AUTO-ENTER#[default],}"
set -g pane-border-style fg=colour240
set -g pane-active-border-style fg=colour45
